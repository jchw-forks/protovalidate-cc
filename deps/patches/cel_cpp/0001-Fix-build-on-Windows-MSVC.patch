From a2672eb2e8fedc20d287b36b89de49541d116366 Mon Sep 17 00:00:00 2001
From: John Chadwick <john@jchw.io>
Date: Sat, 31 Jan 2026 13:21:42 -0500
Subject: [PATCH] Fix build on Windows/MSVC

Some fixes+hacks+workarounds for build issues on MSVC.
---
 common/types/list_type.cc       |  2 +-
 common/types/map_type.cc        |  4 ++--
 common/types/optional_type.cc   |  2 +-
 common/values/optional_value.cc | 18 +++++++++---------
 internal/json.cc                |  5 +++++
 internal/well_known_types.cc    |  5 +++++
 6 files changed, 23 insertions(+), 13 deletions(-)

diff --git a/common/types/list_type.cc b/common/types/list_type.cc
index 118ea15b..a805a383 100644
--- a/common/types/list_type.cc
+++ b/common/types/list_type.cc
@@ -29,7 +29,7 @@ namespace common_internal {
 
 namespace {
 
-ABSL_CONST_INIT const ListTypeData kDynListTypeData;
+const ListTypeData kDynListTypeData;
 
 }  // namespace
 
diff --git a/common/types/map_type.cc b/common/types/map_type.cc
index bd294fc2..9a0305ce 100644
--- a/common/types/map_type.cc
+++ b/common/types/map_type.cc
@@ -29,11 +29,11 @@ namespace common_internal {
 
 namespace {
 
-ABSL_CONST_INIT const MapTypeData kDynDynMapTypeData = {
+const MapTypeData kDynDynMapTypeData = {
     .key_and_value = {DynType(), DynType()},
 };
 
-ABSL_CONST_INIT const MapTypeData kStringDynMapTypeData = {
+const MapTypeData kStringDynMapTypeData = {
     .key_and_value = {StringType(), DynType()},
 };
 
diff --git a/common/types/optional_type.cc b/common/types/optional_type.cc
index a37300bb..3ec51ed8 100644
--- a/common/types/optional_type.cc
+++ b/common/types/optional_type.cc
@@ -47,7 +47,7 @@ static_assert(offsetof(OptionalTypeData, parameters_size) ==
 static_assert(offsetof(OptionalTypeData, parameter) ==
               offsetof(OpaqueTypeData, parameters));
 
-ABSL_CONST_INIT const DynOptionalTypeData kDynOptionalTypeData = {
+const DynOptionalTypeData kDynOptionalTypeData = {
     .optional =
         {
             .name = OptionalType::kName,
diff --git a/common/values/optional_value.cc b/common/values/optional_value.cc
index ad0a65ef..1e1b6ce5 100644
--- a/common/values/optional_value.cc
+++ b/common/values/optional_value.cc
@@ -122,7 +122,7 @@ absl::Status OptionalValueEqual(
   return absl::OkStatus();
 }
 
-ABSL_CONST_INIT const OptionalValueDispatcher
+const OptionalValueDispatcher
     empty_optional_value_dispatcher = {
         {
             .get_type_id = &OptionalValueGetTypeId,
@@ -149,7 +149,7 @@ ABSL_CONST_INIT const OptionalValueDispatcher
         },
 };
 
-ABSL_CONST_INIT const OptionalValueDispatcher null_optional_value_dispatcher = {
+const OptionalValueDispatcher null_optional_value_dispatcher = {
     {
         .get_type_id = &OptionalValueGetTypeId,
         .get_arena = [](const OpaqueValueDispatcher* absl_nonnull,
@@ -171,7 +171,7 @@ ABSL_CONST_INIT const OptionalValueDispatcher null_optional_value_dispatcher = {
        cel::Value* absl_nonnull result) -> void { *result = NullValue(); },
 };
 
-ABSL_CONST_INIT const OptionalValueDispatcher bool_optional_value_dispatcher = {
+const OptionalValueDispatcher bool_optional_value_dispatcher = {
     {
         .get_type_id = &OptionalValueGetTypeId,
         .get_arena = [](const OpaqueValueDispatcher* absl_nonnull,
@@ -195,7 +195,7 @@ ABSL_CONST_INIT const OptionalValueDispatcher bool_optional_value_dispatcher = {
     },
 };
 
-ABSL_CONST_INIT const OptionalValueDispatcher int_optional_value_dispatcher = {
+const OptionalValueDispatcher int_optional_value_dispatcher = {
     {
         .get_type_id = &OptionalValueGetTypeId,
         .get_arena = [](const OpaqueValueDispatcher* absl_nonnull,
@@ -219,7 +219,7 @@ ABSL_CONST_INIT const OptionalValueDispatcher int_optional_value_dispatcher = {
     },
 };
 
-ABSL_CONST_INIT const OptionalValueDispatcher uint_optional_value_dispatcher = {
+const OptionalValueDispatcher uint_optional_value_dispatcher = {
     {
         .get_type_id = &OptionalValueGetTypeId,
         .get_arena = [](const OpaqueValueDispatcher* absl_nonnull,
@@ -243,7 +243,7 @@ ABSL_CONST_INIT const OptionalValueDispatcher uint_optional_value_dispatcher = {
     },
 };
 
-ABSL_CONST_INIT const OptionalValueDispatcher
+const OptionalValueDispatcher
     double_optional_value_dispatcher = {
         {
             .get_type_id = &OptionalValueGetTypeId,
@@ -268,7 +268,7 @@ ABSL_CONST_INIT const OptionalValueDispatcher
         },
 };
 
-ABSL_CONST_INIT const OptionalValueDispatcher
+const OptionalValueDispatcher
     duration_optional_value_dispatcher = {
         {
             .get_type_id = &OptionalValueGetTypeId,
@@ -293,7 +293,7 @@ ABSL_CONST_INIT const OptionalValueDispatcher
         },
 };
 
-ABSL_CONST_INIT const OptionalValueDispatcher
+const OptionalValueDispatcher
     timestamp_optional_value_dispatcher = {
         {
             .get_type_id = &OptionalValueGetTypeId,
@@ -323,7 +323,7 @@ struct OptionalValueContent {
   google::protobuf::Arena* absl_nonnull arena;
 };
 
-ABSL_CONST_INIT const OptionalValueDispatcher optional_value_dispatcher = {
+const OptionalValueDispatcher optional_value_dispatcher = {
     {
         .get_type_id = &OptionalValueGetTypeId,
         .get_arena =
diff --git a/internal/json.cc b/internal/json.cc
index 63724cd6..86da9b07 100644
--- a/internal/json.cc
+++ b/internal/json.cc
@@ -51,6 +51,11 @@
 #include "google/protobuf/message_lite.h"
 #include "google/protobuf/util/time_util.h"
 
+// Workaround for Windows macro conflict.
+#ifdef GetMessage
+#undef GetMessage
+#endif
+
 namespace cel::internal {
 
 namespace {
diff --git a/internal/well_known_types.cc b/internal/well_known_types.cc
index f66a9360..cd91ef9f 100644
--- a/internal/well_known_types.cc
+++ b/internal/well_known_types.cc
@@ -58,6 +58,11 @@
 #include "google/protobuf/reflection.h"
 #include "google/protobuf/util/time_util.h"
 
+// Workaround for Windows macro conflict.
+#ifdef GetMessage
+#undef GetMessage
+#endif
+
 namespace cel::well_known_types {
 
 namespace {
-- 
2.51.2

